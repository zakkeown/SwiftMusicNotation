# Continuous Integration workflow
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Build and test on macOS
  test-macos:
    runs-on: macos-14
    strategy:
      matrix:
        xcode: ['15.0', '15.4']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode ${{ matrix.xcode }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode }}

      - name: Build
        run: swift build -v

      - name: Run Tests
        run: swift test -v

  # Build for iOS (compile check only, no simulator tests)
  build-ios:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build for iOS
        run: |
          xcodebuild build \
            -scheme SwiftMusicNotation \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -skipPackagePluginValidation \
            | xcpretty

  # Check Swift formatting and linting
  lint:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for build warnings
        run: |
          swift build 2>&1 | tee build.log
          if grep -q "warning:" build.log; then
            echo "::warning::Build produced warnings"
          fi
